<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>新游接口测试</title>
    <meta name="Description" content="跳转">
    <meta name="Keywords" content="跳转">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,minimal-ui,viewport-fit=cover">
    <style>
        .html {
            width: 100vw;
        }
        .container {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .link-text {
            line-height: 20px;
            width: 100%;
        }
        .color-block {
            width: 40%;
            height: 50px;
            margin: 10px;
            display: inline-flex;
            justify-items: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            text-align: center;
        }

        .progress {
            font-size: 12px;
            color: #909399;
            width: 100%;
        }

        .gray {
            background-color: #909399;
        }

        .red {
            background-color: #F56C6C;
        }

        .blue {
            background-color: #409EFF;
        }

        .green {
            background-color: #67C23A;
        }

        .yellow {
            background-color: #E6A23C;
        }

    </style>
</head>

<body>

    <h3>这里是需要验证的部分</h3>

    <div class="container">
        <div class="color-block blue" onclick="isGameInstalled('20001')">
            <div class="link-text">isGameInstalled<br/>是否安装王者</div>
        </div>
        <div class="color-block blue" onclick="isGameInstalled('30002')">
            <div class="link-text">isGameInstalled<br/>是否安装破晓</div>
        </div>
        
    </div>
    <div class="container">
        <div class="color-block blue" onclick="getGameState('20001')">
            <div class="link-text">getGameState<br/>获取王者状态</div>
        </div>
        <div class="color-block blue" onclick="getGameState('30002')">
            <div class="link-text">getGameState<br/>获取破晓状态</div>
        </div>
    </div>

    <div class="container">
        <div class="color-block green" onclick="downloadGame('20001')">
            <div class="link-text">downloadGame<br/>下载王者</div>
        </div>
        <div class="color-block green" onclick="downloadGame('30002')">
            <div class="link-text">downloadGame<br/>下载破晓</div>
        </div>
    </div>

    <div class="container">
        <div class="progress">
            王者下载进度
            <div id="pvp"></div>
        </div>
    </div>
    <div class="container">
        <div class="progress">
            破晓下载进度
            <div id="wedo"></div>
        </div>
    </div>


    <div class="container">
        <div class="color-block red" onclick="cancelDownloadGame('20001')">
            <div class="link-text">cancelDownloadGame<br/>取消下载王者</div>
        </div>
        <div class="color-block red" onclick="cancelDownloadGame('30002')">
            <div class="link-text">cancelDownloadGame<br/>取消下载破晓</div>
        </div>
    </div>

    <div class="container">
        <div class="color-block yellow" onclick="pauseDownloadGame('20001')">
            <div class="link-text">pauseDownloadGame<br/>暂停下载王者</div>
        </div>
        <div class="color-block yellow" onclick="pauseDownloadGame('30002')">
            <div class="link-text">pauseDownloadGame<br/>暂停下载破晓</div>
        </div>
    </div>

    <div class="container">
        <div class="color-block green" onclick="resumeDownloadGame('20001')">
            <div class="link-text">resumeDownloadGame<br/>恢复下载王者</div>
        </div>
        <div class="color-block green" onclick="resumeDownloadGame('30002')">
            <div class="link-text">resumeDownloadGame<br/>恢复下载破晓</div>
        </div>
    </div>

    <div class="container">
        <div class="color-block green" onclick="installGame('20001')">
            <div class="link-text">installGame<br/>安装王者</div>
        </div>
        <div class="color-block green" onclick="installGame('30002')">
            <div class="link-text">installGame<br/>安装破晓</div>
        </div>
    </div>

    <div class="container">
        <div class="color-block gray" onclick="testEvent()">
            <div class="link-text">触发事件</div>
        </div>
    </div>
    <div class="container">
        <div class="progress">
            触发事件返回
            <div id="event"></div>
        </div>
    </div>

    <div class="container">
        <div class="color-block gray" onclick="goPrev()">
            <div class="link-text">退出</div>
        </div>
    </div>

    
</body>

<script src="//camp.qq.com/h5/webdist/sdk/camp-launch-app/camp-launch-app.1.12.0.min.js"></script>
<script src="https://camp.qq.com/h5/webdist/sdk/camp-jsbridge/camp-jsbridge.latest.min.js"></script>
<script src="//camp.qq.com/h5/webdist/sdk/camp-api/index.umd.min.js"></script>
<script src="https://game.gtimg.cn/images/ulink/ulinksdk/vconsole.min.js"></script>

<script src="//ossweb-img.qq.com/images/js/eas/eas.js"></script>
<script src="https://game.gtimg.cn/images/ulink/ulinksdk/vconsole.min.js"></script>
<script>
    var vConsole = new VConsole();
</script>
</html>

<script>
    //desc="多游id 20001:王者;30002:破晓;30001:万象棋;30003:王者世界" 
    // 游戏是否已安装
    function isGameInstalled(game_key) {
        window.CampApi.callOneApi('isGameInstalled', { "game_key": game_key }).then((res) => {
            console.log('isGameInstalled==>', res)
            if (res.data[game_key] == 1) {
                alert("已安装");
            } else {
                alert("未安装");
            }
        }).catch(e => {
            alert('isGameInstalled 异常')
            console.error('isGameInstalled 异常', e)
        });
    }

    // 获取游戏状态
    function getGameState(game_key){
        window.CampApi.callOneApi('getGameState', { "game_key": game_key }).then((res) => {
            console.log('getGameState===>', res)
            var map = {
                0: '未知状态，游戏不可用',
                1: '检查更新中',
                2: '下载/更新',
                3: '下载中',
                4: '下载完成',
                5: '安装完成',
                100: '其他状态（扫描/安装/卸载等）',
            }
            alert(map[res.data[game_key]]) ;

        }).catch(e => {
            alert('getGameState 异常')
            console.error('getGameState 异常', e)
        });
    }

    // 下载游戏
    function downloadGame(game_key) {
        window.CampApi.callOneApi('downloadGame', { "game_key": game_key }).then((res) => {
            console.log('downloadGame===>', res)
            alert('downloadGame===>'+JSON.stringify(res))
            window.OneEvent.addEventListener('onGameDownloadProgress', (params) => {
                console.log('onGameDownloadProgress=====>', params)
                if (game_key == '20001') {
                    document.getElementById('pvp').innerHTML = JSON.stringify(params)
                } else if (game_key == '30002') {
                    document.getElementById('wedo').innerHTML = JSON.stringify(params)
                }
            }, {
                capture: true,	// 是否拦截消息
                once: false,		// 是否是单次订阅
                scopes: 2			// 由于 OneEvent 目前是靠容器注入，所以目前只能用枚举的原始值指定 scope
            })
        }).catch(e => {
            alert('downloadGame 异常')
            console.error('downloadGame 异常', e)
        });
    }


    // 取消下载游戏
    function cancelDownloadGame(game_key) {
        window.CampApi.callOneApi('cancelDownloadGame', { "game_key": game_key }).then((res) => {
            console.log('cancelDownloadGame===>', res)
            alert('cancelDownloadGame===>'+JSON.stringify(res))
        }).catch(e => {
            alert('cancelDownloadGame 异常')
            console.error('cancelDownloadGame 异常', e)
        });
    }

    // 暂停下载游戏
    function pauseDownloadGame(game_key) {
        window.CampApi.callOneApi('pauseDownloadGame', { "game_key": game_key }).then((res) => {
            console.log('pauseDownloadGame====>', res)
            alert('pauseDownloadGame===>'+JSON.stringify(res))
        }).catch(e => {
            alert('pauseDownloadGame 异常')
            console.error('pauseDownloadGame====>', e)
        });
    }

    // 恢复下载游戏
    function resumeDownloadGame(game_key) {
        window.CampApi.callOneApi('resumeDownloadGame', { "game_key": game_key }).then((res) => {
            console.log('resumeDownloadGame===>', res)
            alert('resumeDownloadGame===>'+JSON.stringify(res))
        }).catch(e => {
            alert('resumeDownloadGame 异常')
            console.error('resumeDownloadGame 异常', e)
        });
    }

    // 安装游戏
    function installGame(game_key) {
        window.CampApi.callOneApi('installGame', { "game_key": game_key }).then((res) => {
            console.log('installGame==>', res)
            alert('installGame===>'+JSON.stringify(res))
        }).catch(e => {
            alert('installGame 异常')
            console.error('installGame 异常', e)
        });
    }


    // 触发事件
    function testEvent() {
        window.OneEvent.dispatchEvent(
            'testEvent', 
            { 'data': '测试触发事件testEvent' },
            true 	// 是否是粘性事件
        );
        window.OneEvent.addEventListener('testEvent', (params) => {
            console.log('testEvent=====>', params)
            document.getElementById('event').innerHTML = JSON.stringify(params)
        }, {
                capture: true,	// 是否拦截消息
                once: true,		// 是否是单次订阅
                scopes: 4			// 由于 OneEvent 目前是靠容器注入，所以目前只能用枚举的原始值指定 scope
        })
    }


    // 退出
    function goPrev() {
        if (
            window.CampJsBridge &&
            typeof window.CampJsBridge.closeActivity === "function"
        ) {
            window.CampJsBridge.closeActivity();
        } else {
            console.error('CampJsBridge load failed');
        }
    }


    setTimeout(function () {
        console.log('OneEvent===>', window.OneEvent)
    }, 1500)



    // 非营地内，拉起营地
    const {
        launchCamp,
        launchApp
    } = window.Camp && window.Camp;

    function isCamp() {
        var ua = window.navigator.userAgent.toLowerCase();
        if (/gamehelper/i.test(ua)) {
            return true;
        } else {
            return false;
        }
    }

    function locationtocamp() {
        var openurl = 'https://pvp.qq.com/cp/a20240319lwgf/wedoTest.html?isNavigationBarHidden=0'
        launchCamp('web?url=' + encodeURIComponent(openurl), {
            androidDownloadUrl: 'https://camp.qq.com/h5/webdist/redirect-app/index.html', // 
            androidShop: '',
            handleSuccess: () => {
            },
            handleFailed: () => {
            }
        }
        )
    }
    if (isCamp()) {
        //    refreshTicket();
    } else {
        setTimeout(function () {
            locationtocamp()
        }, 1500)
    }

</script>
